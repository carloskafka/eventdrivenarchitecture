name: CI / CD

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]

permissions:
  # Need write access to repository contents in order to create releases and upload assets
  contents: write
  packages: write
  id-token: write

jobs:
  build:
    name: Build, Test and (on main) Publish
    runs-on: ubuntu-latest
    env:
      PACKAGES_TOKEN: ${{ secrets.PACKAGES_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Cache Maven local repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: Build (multi-module) and run tests
        run: mvn -B -ntp -T 1C clean verify

      - name: Upload build artifacts (backend JAR)
        if: success() && steps['Build (multi-module) and run tests']
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/backend-1.0.0-SNAPSHOT.jar

      # Deploy from the same runner that built and populated the local Maven cache.
      - name: Set up JDK 21 for deploy (with credentials)
        if: github.ref == 'refs/heads/main'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          server-id: github
          server-username: ${{ github.actor }}
          server-password: ${{ secrets.PACKAGES_TOKEN != '' && secrets.PACKAGES_TOKEN || secrets.GITHUB_TOKEN }}
          cache: maven

      - name: Pre-deploy central connectivity check (diagnostic)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Checking Maven Central connectivity for plugin POM (repo1.maven.org)..."
          url=https://repo1.maven.org/maven2/org/apache/maven/plugins/maven-install-plugin/3.1.2/maven-install-plugin-3.1.2.pom
          hdr=$(mktemp)
          http=$(curl -s -D "$hdr" -o /dev/null -w "%{http_code}" "$url")
          echo "HTTP status for $url : $http"
          echo "--- Response headers ---"
          sed -n '1,200p' "$hdr"
          if [ "$http" != "200" ]; then
            echo "Maven Central returned HTTP $http for plugin POM. This may indicate network/ACL issues or a mirror/proxy blocking access.";
            echo "CENTRAL_OK=0" >> $GITHUB_ENV
          else
            echo "CENTRAL_OK=1" >> $GITHUB_ENV
          fi

      - name: Diagnostic - print masked settings.xml and env values
        if: github.ref == 'refs/heads/main' && env.CENTRAL_OK == '1'
        run: |
          echo "Masked settings.xml:"
          sed 's/<password>.*<\/password>/<password>***MASKED***<\/password>/' .github/maven/settings.xml || echo "No settings.xml found"
          echo "GITHUB_ACTOR: $GITHUB_ACTOR"
          echo "GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "PACKAGES_TOKEN length: ${#PACKAGES_TOKEN}"
          echo "MAVEN_OPTS: $MAVEN_OPTS"

      - name: GitHub Packages auth check (diagnostic)
        if: github.ref == 'refs/heads/main' && env.CENTRAL_OK == '1'
        run: |
          owner=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1)
          meta_url="https://maven.pkg.github.com/$GITHUB_REPOSITORY/com/example/eventdrivenarchitecture/1.0.0-SNAPSHOT/maven-metadata.xml"
          hdr=$(mktemp)
          body=$(mktemp)
          echo "Checking auth to $meta_url as user $owner"
          http=$(curl -s -D "$hdr" -o "$body" -u "$owner:$PACKAGES_TOKEN" "$meta_url" -w "%{http_code}")
          echo "HTTP status: $http"
          echo "--- Response headers ---"
          sed -n '1,200p' "$hdr"
          echo "--- Response body (first 400 chars) ---"
          head -c 400 "$body" | sed -n '1,200p'
          if [ "$http" != "200" ]; then
            echo "Authentication to GitHub Packages failed (HTTP $http). If 401/403, verify PACKAGES_TOKEN scopes (repo/packages) and SAML SSO authorization.";
            exit 1
          fi

      - name: Write Maven settings with GitHub Packages credentials
        if: github.ref == 'refs/heads/main' && env.CENTRAL_OK == '1'
        run: |
          mkdir -p "$HOME/.m2"
          owner=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1)
          cat > "$HOME/.m2/settings.xml" <<EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${owner}</username>
                <password>${PACKAGES_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF
          echo "Wrote settings.xml to $HOME/.m2/settings.xml (password masked in logs); username set to repo owner: $owner"

      - name: Deploy artifacts to GitHub Packages (from build)
        if: github.ref == 'refs/heads/main' && env.CENTRAL_OK == '1'
        env:
          MAVEN_OPTS: -Xmx2g
        run: |
          echo "Deploying to GitHub Packages using altDeploymentRepository (from build job)"
          mvn -B -ntp -T 1C clean deploy -DskipTests -Dgpg.skip=true -DaltDeploymentRepository=github::default::https://maven.pkg.github.com/$GITHUB_REPOSITORY -e -X

      - name: Skip deploy notice
        if: github.ref == 'refs/heads/main' && env.CENTRAL_OK != '1'
        run: echo "Maven Central connectivity check failed; creating fallback GitHub Release and uploading backend artifact"

      - name: Create fallback release and upload backend JAR
        if: github.ref == 'refs/heads/main' && env.CENTRAL_OK != '1'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: fallback-${{ github.run_id }}
          files: backend/target/backend-1.0.0-SNAPSHOT.jar
        env:
          # Prefer a PAT for creating releases if available; fall back to GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.PACKAGES_TOKEN != '' && secrets.PACKAGES_TOKEN || secrets.GITHUB_TOKEN }}

  release:
    name: Create GitHub Release and upload backend JAR
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build backend artifact (skip tests)
        run: mvn -B -ntp -T 1C -pl backend -am clean package -DskipTests

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.PACKAGES_TOKEN != '' && secrets.PACKAGES_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Upload backend JAR to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: backend/target/backend-1.0.0-SNAPSHOT.jar
        env:
          GITHUB_TOKEN: ${{ secrets.PACKAGES_TOKEN != '' && secrets.PACKAGES_TOKEN || secrets.GITHUB_TOKEN }}
